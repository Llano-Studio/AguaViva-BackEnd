generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int                   @id @default(autoincrement())
  email                  String                @unique
  password               String
  name                   String
  role                   Role                  @default(SUPERADMIN)
  isActive               Boolean               @default(true)
  isEmailConfirmed       Boolean               @default(false)
  emailConfirmationToken String?               @unique
  emailTokenExpires      DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime?
  recoveryToken          String?               @unique
  recoveryTokenExpires   DateTime?
  profileImageUrl        String?
  refresh_tokens       RefreshToken[]
  incidents_created    delivery_incident[]   @relation("incidentCreator")
  incidents_resolved   delivery_incident[]   @relation("incidentResolver")
  delivery_stats       delivery_stats[]
  payment_transactions payment_transaction[] @relation("PaymentTransactionUser")
  payment_transactions_updated payment_transaction[] @relation("PaymentTransactionUpdatedBy")
  cycle_payments_created cycle_payment[]     @relation("CyclePaymentCreatedBy")
  cycle_payments_updated cycle_payment[]     @relation("CyclePaymentUpdatedBy")
  payment_audits       payment_audit[]       @relation("PaymentAuditCreatedBy")
  collection_payment_transactions_created collection_payment_transaction[] @relation("CollectionPaymentTransactionCreatedBy")
  collection_payment_transactions_updated collection_payment_transaction[] @relation("CollectionPaymentTransactionUpdatedBy")
  route_sheet          route_sheet[]
  stock_movements      stock_movement[]
  user_vehicle         user_vehicle[]
  comodato_changes     comodato_change[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model country {
  country_id Int        @id @default(autoincrement()) @db.SmallInt
  code       String     @unique @db.VarChar(10)
  name       String     @db.VarChar(100)
  province   province[]
}

model province {
  province_id Int        @id @default(autoincrement()) @db.SmallInt
  country_id  Int        @db.SmallInt
  code        String     @unique @db.VarChar(10)
  name        String     @db.VarChar(100)
  locality    locality[]
  country     country    @relation(fields: [country_id], references: [country_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_province_country")
}

model locality {
  locality_id              Int                       @id @default(autoincrement()) @db.SmallInt
  province_id              Int                       @db.SmallInt
  code                     String                    @unique @db.VarChar(10)
  name                     String                    @db.VarChar(100)
  is_active                Boolean                   @default(true)
  province                 province                  @relation(fields: [province_id], references: [province_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_locality_province")
  one_off_purchase         one_off_purchase[]
  one_off_purchase_headers one_off_purchase_header[]
  person                   person[]
  warehouse                warehouse[]
  zones                    zone[]
}

model zone {
  zone_id                  Int                       @id @default(autoincrement()) @db.SmallInt
  code                     String                    @db.VarChar(10)
  name                     String                    @db.VarChar(100)
  locality_id              Int                       @db.SmallInt
  is_active                Boolean                   @default(true)
  delivery_stats           delivery_stats[]
  one_off_purchase         one_off_purchase[]
  one_off_purchase_headers one_off_purchase_header[]
  order_header             order_header[]
  collection_orders        collection_orders[]       @relation("CollectionOrderZone")
  person                   person[]
  vehicle_zone             vehicle_zone[]
  locality                 locality                  @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_zone_locality")

  @@unique([locality_id, code], name: "unique_zone_code_per_locality")
  @@unique([locality_id, name], name: "unique_zone_name_per_locality")
}

model product_category {
  category_id Int       @id @default(autoincrement()) @db.SmallInt
  name        String    @db.VarChar(50)
  product     product[]
}

model product {
  product_id                Int                         @id @default(autoincrement())
  category_id               Int                         @db.SmallInt
  description               String                      @db.VarChar(100)
  volume_liters             Decimal?                    @db.Decimal(5, 2)
  price                     Decimal                     @db.Decimal(10, 2)
  is_returnable             Boolean
  serial_number             String?                     @db.VarChar(50)
  notes                     String?
  image_url                 String?                     @db.VarChar(255)
  is_active                 Boolean                     @default(true)
  inventory                 inventory[]
  inventory_transaction     inventory_transaction[]
  one_off_purchase          one_off_purchase[]
  one_off_purchase_items    one_off_purchase_item[]
  order_item                order_item[]
  collection_order_items    collection_order_item[]     @relation("CollectionOrderItemProduct")
  payment_line              payment_line[]
  price_list_item           price_list_item[]
  comodatos                 comodato[]
  product_category          product_category            @relation(fields: [category_id], references: [category_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_product_category")
  stock_movement            stock_movement[]
  subscription_cycle_detail subscription_cycle_detail[]
  subscription_plan_product subscription_plan_product[]
  vehicle_inventory         vehicle_inventory[]
  vehicle_route_inventory   vehicle_route_inventory[]
}

model price_list {
  price_list_id                     Int                       @id @default(autoincrement())
  name                              String                    @db.VarChar(50)
  effective_date                    DateTime                  @db.Date
  active                            Boolean                   @default(true)
  created_at                        DateTime                  @default(now())
  description                       String?                   @db.VarChar(255)
  is_default                        Boolean                   @default(false)
  updated_at                        DateTime                  @updatedAt
  is_active                         Boolean                   @default(true)
  client_contract                   client_contract[]
  one_off_purchases                 one_off_purchase[]
  one_off_purchase_headers          one_off_purchase_header[]
  one_off_purchase_items_individual one_off_purchase_item[]   @relation("ItemPriceList")
  order_items_individual            order_item[]              @relation("OrderItemPriceList")
  collection_order_items            collection_order_item[]   @relation("CollectionOrderItemPriceList")
  price_list_item                   price_list_item[]
}

model price_list_item {
  price_list_item_id Int                  @id @default(autoincrement())
  price_list_id      Int
  product_id         Int
  unit_price         Decimal              @db.Decimal(10, 2)
  price_history      price_list_history[]
  price_list         price_list           @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pricelistitem_pricelist")
  product            product              @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pricelistitem_product")
}

model price_list_history {
  history_id         Int             @id @default(autoincrement())
  price_list_item_id Int
  previous_price     Decimal         @db.Decimal(10, 2)
  new_price          Decimal         @db.Decimal(10, 2)
  change_date        DateTime        @default(now()) @db.Timestamp(6)
  change_percentage  Decimal?        @db.Decimal(10, 2)
  change_reason      String?
  created_by         String?         @db.VarChar(100)
  price_list_item    price_list_item @relation(fields: [price_list_item_id], references: [price_list_item_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([price_list_item_id])
  @@index([change_date])
}

model warehouse {
  warehouse_id                                                      Int              @id @default(autoincrement()) @db.SmallInt
  name                                                              String           @db.VarChar(100)
  locality_id                                                       Int?             @db.SmallInt
  inventory                                                         inventory[]
  stock_movement_stock_movement_destination_warehouse_idTowarehouse stock_movement[] @relation("stock_movement_destination_warehouse_idTowarehouse")
  stock_movement_stock_movement_source_warehouse_idTowarehouse      stock_movement[] @relation("stock_movement_source_warehouse_idTowarehouse")
  locality                                                          locality?        @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_warehouse_locality")
}

model inventory {
  warehouse_id Int       @db.SmallInt
  product_id   Int
  quantity     Int
  product      product   @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_inventory_product")
  warehouse    warehouse @relation(fields: [warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_inventory_warehouse")

  @@id([warehouse_id, product_id])
}

model movement_type {
  movement_type_id Int              @id @default(autoincrement()) @db.SmallInt
  code             String           @unique @db.VarChar(10)
  description      String           @db.VarChar(100)
  stock_movement   stock_movement[]
}

model stock_movement {
  stock_movement_id                                            Int           @id @default(autoincrement())
  movement_date                                                DateTime      @db.Timestamp(6)
  movement_type_id                                             Int           @db.SmallInt
  product_id                                                   Int
  source_warehouse_id                                          Int?          @db.SmallInt
  destination_warehouse_id                                     Int?          @db.SmallInt
  quantity                                                     Int
  remarks                                                      String?
  order_id                                                     Int?
  reference_document                                           String?       @db.VarChar(50)
  user_id                                                      Int?
  warehouse_stock_movement_destination_warehouse_idTowarehouse warehouse?    @relation("stock_movement_destination_warehouse_idTowarehouse", fields: [destination_warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_dest_warehouse")
  movement_type                                                movement_type @relation(fields: [movement_type_id], references: [movement_type_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_movement_type")
  product                                                      product       @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_product")
  warehouse_stock_movement_source_warehouse_idTowarehouse      warehouse?    @relation("stock_movement_source_warehouse_idTowarehouse", fields: [source_warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_source_warehouse")
  order_header                                                 order_header? @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction)
  user                                                         User?         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model person {
  person_id                Int                       @id @default(autoincrement())
  phone                    String                    @unique @db.VarChar(20)
  additional_phones        String?                   @db.VarChar(200)
  secondary_phone          String?                   @db.VarChar(20)
  name                     String?                   @db.VarChar(100)
  tax_id                   String?                   @db.VarChar(20)
  address                  String?                   @db.VarChar(200)
  locality_id              Int?                      @db.SmallInt
  zone_id                  Int?                      @db.SmallInt
  registration_date        DateTime                  @default(dbgenerated("CURRENT_DATE")) @db.Date
  type                     PersonType
  alias                    String?                   @db.VarChar(100)
  notes                    String?                   @db.Text
  is_active                Boolean                   @default(true)
  owns_returnable_containers Boolean                 @default(false)
  client_contract          client_contract[]
  customer_subscription    customer_subscription[]
  one_off_purchase         one_off_purchase[]
  one_off_purchase_headers one_off_purchase_header[]
  orders                   order_header[]            @relation("OrderHeaderToPerson")
  collection_orders        collection_orders[]       @relation("CollectionOrderToPerson")
  paymentInstallments      payment_installment[]     @relation("PaymentInstallmentToPerson")
  comodatos                comodato[]
  locality                 locality?                 @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction)
  zone                     zone?                     @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([name])
  @@index([alias])
  @@index([tax_id])
}

model client_contract {
  contract_id                Int                          @id @default(autoincrement())
  person_id                  Int
  price_list_id              Int
  start_date                 DateTime                     @db.Date
  end_date                   DateTime?                    @db.Date
  notes                      String?
  status                     ContractStatus               @default(ACTIVE)
  person                     person                       @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_contract_person")
  price_list                 price_list                   @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_contract_pricelist")
  contract_delivery_schedule contract_delivery_schedule[]
  order_header               order_header[]
  collection_orders          collection_orders[]          @relation("CollectionOrderContract")
}

model contract_delivery_schedule {
  schedule_id     Int             @id @default(autoincrement())
  contract_id     Int
  day_of_week     Int             @db.SmallInt
  scheduled_time  DateTime        @db.Time(6)
  client_contract client_contract @relation(fields: [contract_id], references: [contract_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_schedule_contract")
}

model subscription_plan {
  subscription_plan_id         Int                         @id @default(autoincrement()) @db.SmallInt
  name                         String                      @db.VarChar(50)
  description                  String?
  price                        Decimal?                    @db.Decimal(10, 2)
  type                         PersonType                  @default(PLAN)
  created_at                   DateTime                    @default(now())
  default_cycle_days           Int                         @default(30)
  default_deliveries_per_cycle Int                         @default(1)
  is_active                    Boolean                     @default(true)
  updated_at                   DateTime                    @updatedAt
  customer_subscription        customer_subscription[]
  subscription_plan_product    subscription_plan_product[]
}

model subscription_plan_product {
  spp_id               Int               @id @default(autoincrement())
  subscription_plan_id Int               @db.SmallInt
  product_id           Int
  product_quantity     Int
  subscription_plan    subscription_plan @relation(fields: [subscription_plan_id], references: [subscription_plan_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_spp_plan")
  product              product           @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_spp_product")
}

model customer_subscription {
  subscription_id                Int                              @id @default(autoincrement())
  customer_id                    Int
  subscription_plan_id           Int                              @db.SmallInt
  start_date                     DateTime                         @db.Date
  collection_day                 Int?                             @db.SmallInt
  payment_mode                   PaymentMode                      @default(ADVANCE)
  payment_due_day                Int?                             @db.SmallInt
  status                         SubscriptionStatus
  notes                          String?
  cancellation_reason            String?                          @db.Text
  cancellation_date              DateTime?                        @db.Date
  collection_scheduled_date      DateTime?                        @db.Date
  collection_completed           Boolean                          @default(false)
  is_active                      Boolean                          @default(true)
  subscription_plan              subscription_plan                @relation(fields: [subscription_plan_id], references: [subscription_plan_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cust_sub_plan")
  person                         person                           @relation(fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_customer_subscription_person")
  order_header                   order_header[]
  collection_orders              collection_orders[]              @relation("CollectionOrderSubscription")
  subscription_cycle             subscription_cycle[]
  subscription_delivery_schedule subscription_delivery_schedule[]
  cancellation_orders            cancellation_order[]
  comodatos                      comodato[]

  @@index([status])
}

model subscription_cycle {
  cycle_id                  Int                         @id @default(autoincrement())
  subscription_id           Int
  cycle_number              Int
  cycle_start               DateTime                    @db.Date
  cycle_end                 DateTime                    @db.Date
  payment_due_date          DateTime?                   @db.Date
  is_overdue                Boolean                     @default(false)
  late_fee_applied          Boolean                     @default(false)
  late_fee_percentage       Decimal?                    @db.Decimal(5,2)
  notes                     String?
  total_amount              Decimal?                    @db.Decimal(10, 2)
  paid_amount               Decimal                     @default(0) @db.Decimal(10, 2)
  pending_balance           Decimal                     @default(0) @db.Decimal(10, 2)
  credit_balance            Decimal                     @default(0) @db.Decimal(10, 2)
  payment_status            PaymentStatus               @default(PENDING)
  customer_subscription     customer_subscription       @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_subscription")
  subscription_cycle_detail subscription_cycle_detail[]
  cycle_payments            cycle_payment[]

  @@unique([subscription_id, cycle_number])
}

model subscription_cycle_detail {
  cycle_detail_id    Int                @id @default(autoincrement())
  cycle_id           Int
  product_id         Int
  planned_quantity   Int
  delivered_quantity Int                @default(0)
  remaining_balance  Int
  subscription_cycle subscription_cycle @relation(fields: [cycle_id], references: [cycle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_detail_cycle")
  product            product            @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_detail_product")
}

model subscription_delivery_schedule {
  schedule_id           Int                   @id @default(autoincrement())
  subscription_id       Int
  day_of_week           Int                   @db.SmallInt
  scheduled_time        String                @db.VarChar(20)
  customer_subscription customer_subscription @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_sub_schedule_subscription")
}

model sale_channel {
  sale_channel_id          Int                       @id @default(autoincrement()) @db.SmallInt
  code                     String                    @unique @db.VarChar(20)
  description              String                    @db.VarChar(100)
  one_off_purchase         one_off_purchase[]
  one_off_purchase_headers one_off_purchase_header[]
  order_header             order_header[]
  collection_orders        collection_orders[]       @relation("CollectionOrderSaleChannel")
}

model order_header {
  order_id                Int                      @id @default(autoincrement())
  customer_id             Int
  contract_id             Int?
  sale_channel_id         Int                      @default(1) @db.SmallInt
  order_date              DateTime                 @db.Timestamp(6)
  scheduled_delivery_date DateTime?                @db.Timestamp(6)
  delivery_time           String?                  @db.VarChar(20)
  total_amount            Decimal                  @db.Decimal(10, 2)
  paid_amount             Decimal                  @db.Decimal(10, 2)
  order_type              OrderType
  status                  OrderStatus
  payment_status          String                   @default("PENDING")
  notes                   String?
  subscription_id         Int?
  zone_id                 Int?                     @db.SmallInt
  is_active               Boolean                  @default(true)
  installment_order_link  installment_order_link[]
  client_contract         client_contract?         @relation(fields: [contract_id], references: [contract_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_contract")
  sale_channel            sale_channel             @relation(fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_salechannel")
  customer                person                   @relation("OrderHeaderToPerson", fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  customer_subscription   customer_subscription?   @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction)
  zone                    zone?                    @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)
  order_item              order_item[]
  payment_transaction     payment_transaction[]
  route_sheet_detail      route_sheet_detail[]
  stock_movements         stock_movement[]

  @@index([order_date])
  @@index([status])
}

model collection_orders {
  collection_order_id     Int                      @id @default(autoincrement())
  customer_id             Int
  contract_id             Int?
  sale_channel_id         Int                      @default(1) @db.SmallInt
  order_date              DateTime                 @db.Timestamp(6)
  scheduled_delivery_date DateTime?                @db.Timestamp(6)
  delivery_time           String?                  @db.VarChar(20)
  total_amount            Decimal                  @db.Decimal(10, 2)
  paid_amount             Decimal                  @db.Decimal(10, 2)
  order_type              OrderType
  status                  OrderStatus
  payment_status          String                   @default("PENDING")
  notes                   String?
  subscription_id         Int?
  zone_id                 Int?                     @db.SmallInt
  is_active               Boolean                  @default(true)
  es_automatica           Boolean                  @default(false)
  client_contract         client_contract?         @relation("CollectionOrderContract", fields: [contract_id], references: [contract_id], onDelete: NoAction, onUpdate: NoAction)
  sale_channel            sale_channel             @relation("CollectionOrderSaleChannel", fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction)
  customer                person                   @relation("CollectionOrderToPerson", fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  customer_subscription   customer_subscription?   @relation("CollectionOrderSubscription", fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction)
  zone                    zone?                    @relation("CollectionOrderZone", fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)
  collection_order_items  collection_order_item[]
  collection_payment_transactions collection_payment_transaction[]

  @@index([order_date])
  @@index([status])
  @@index([es_automatica])
  @@index([customer_id])
  @@map("ordenes_de_cobranza")
}

model collection_order_item {
  collection_order_item_id Int                      @id @default(autoincrement())
  collection_order_id      Int
  product_id               Int
  quantity                 Int
  subtotal                 Decimal                  @db.Decimal(10, 2)
  notes                    String?
  price_list_id            Int?
  unit_price               Decimal                  @db.Decimal(10, 2)
  delivered_quantity       Int?                     @default(0)
  returned_quantity        Int?                     @default(0)
  collection_order         collection_orders        @relation(fields: [collection_order_id], references: [collection_order_id], onDelete: Cascade, onUpdate: NoAction)
  price_list               price_list?              @relation("CollectionOrderItemPriceList", fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction)
  product                  product                  @relation("CollectionOrderItemProduct", fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([collection_order_id])
  @@index([product_id])
  @@index([price_list_id])
}

model collection_payment_transaction {
  collection_payment_transaction_id Int                @id @default(autoincrement())
  collection_order_id               Int
  payment_method_id                 Int
  amount                            Decimal            @db.Decimal(10, 2)
  transaction_reference             String?            @db.VarChar(100)
  payment_date                      DateTime           @default(now()) @db.Timestamp(6)
  notes                             String?
  created_by                        Int
  updated_by                        Int?
  created_at                        DateTime           @default(now()) @db.Timestamp(6)
  updated_at                        DateTime?          @db.Timestamp(6)
  collection_order                  collection_orders  @relation(fields: [collection_order_id], references: [collection_order_id], onDelete: Cascade, onUpdate: NoAction)
  payment_method                    payment_method     @relation("CollectionPaymentMethod", fields: [payment_method_id], references: [payment_method_id], onDelete: NoAction, onUpdate: NoAction)
  created_by_user                   User               @relation("CollectionPaymentTransactionCreatedBy", fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  updated_by_user                   User?              @relation("CollectionPaymentTransactionUpdatedBy", fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([collection_order_id])
  @@index([payment_method_id])
  @@index([payment_date])
}

model order_item {
  order_item_id          Int                      @id @default(autoincrement())
  order_id               Int
  product_id             Int
  quantity               Int
  subtotal               Decimal                  @db.Decimal(10, 2)
  notes                  String?
  price_list_id          Int?
  unit_price             Decimal                  @db.Decimal(10, 2)
  delivered_quantity     Int?                     @default(0)
  returned_quantity      Int?                     @default(0)
  installment_order_link installment_order_link[]
  order_header           order_header             @relation(fields: [order_id], references: [order_id], onDelete: Cascade, onUpdate: NoAction)
  price_list             price_list?              @relation("OrderItemPriceList", fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction)
  product                product                  @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([order_id])
  @@index([product_id])
  @@index([price_list_id])
}

model one_off_purchase {
  purchase_id             Int          @id @default(autoincrement())
  person_id               Int
  product_id              Int
  quantity                Int
  total_amount            Decimal      @db.Decimal(10, 2)
  purchase_date           DateTime     @default(now()) @db.Timestamp(6)
  sale_channel_id         Int          @db.SmallInt
  delivery_address        String?
  locality_id             Int?         @db.SmallInt
  zone_id                 Int?         @db.SmallInt
  scheduled_delivery_date DateTime?    @db.Timestamp(6)
  delivery_time           String?      @db.VarChar(50)
  notes                   String?
  paid_amount             Decimal      @default(0) @db.Decimal(10, 2)
  price_list_id           Int?
  delivered_quantity      Int?         @default(0)
  requires_delivery       Boolean      @default(false)
  returned_quantity       Int?         @default(0)
  status                  String       @default("PENDING") @db.VarChar(20)
  is_active               Boolean      @default(true)
  locality                locality?              @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction)
  person                  person                 @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  price_list              price_list?            @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction)
  product                 product                @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  sale_channel            sale_channel           @relation(fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction)
  zone                    zone?                  @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)
  route_sheet_detail      route_sheet_detail[]   

  @@index([status])
  @@index([requires_delivery])
}

model one_off_purchase_header {
  purchase_header_id      Int                     @id @default(autoincrement())
  person_id               Int
  sale_channel_id         Int                     @db.SmallInt
  purchase_date           DateTime                @default(now()) @db.Timestamp(6)
  total_amount            Decimal                 @db.Decimal(10, 2)
  paid_amount             Decimal                 @default(0) @db.Decimal(10, 2)
  delivery_address        String?
  locality_id             Int?                    @db.SmallInt
  zone_id                 Int?                    @db.SmallInt
  price_list_id           Int?
  notes                   String?
  status                  String                  @default("PENDING") @db.VarChar(20)
  payment_status          String                  @default("PENDING") @db.VarChar(20)
  delivery_status         String                  @default("PENDING") @db.VarChar(20)
  created_at              DateTime                @default(now())
  updated_at              DateTime                @updatedAt
  scheduled_delivery_date DateTime?               @db.Timestamp(6)
  delivery_time           String?                 @db.VarChar(50)
  is_active               Boolean                 @default(true)
  locality                locality?               @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction)
  person                  person                  @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  price_list              price_list?             @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction)
  sale_channel            sale_channel            @relation(fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction)
  zone                    zone?                   @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)
  purchase_items          one_off_purchase_item[]
  route_sheet_detail      route_sheet_detail[]    

  @@index([purchase_date])
  @@index([scheduled_delivery_date])
  @@index([status])
  @@index([person_id])
}

model one_off_purchase_item {
  purchase_item_id   Int                     @id @default(autoincrement())
  purchase_header_id Int
  product_id         Int
  quantity           Int
  unit_price         Decimal                 @db.Decimal(10, 2)
  subtotal           Decimal                 @db.Decimal(10, 2)
  notes              String?
  price_list_id      Int?
  price_list         price_list?             @relation("ItemPriceList", fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction)
  product            product                 @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  purchase_header    one_off_purchase_header @relation(fields: [purchase_header_id], references: [purchase_header_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([purchase_header_id])
  @@index([product_id])
  @@index([price_list_id])
}

model payment_method {
  payment_method_id                 Int                                 @id @default(autoincrement()) @db.SmallInt
  code                              String                              @unique @db.VarChar(20)
  description                       String                              @db.VarChar(100)
  payment_transaction               payment_transaction[]
  collection_payment_transactions  collection_payment_transaction[]    @relation("CollectionPaymentMethod")
}

model payment_transaction {
  transaction_id     Int            @id @default(autoincrement())
  transaction_date   DateTime       @db.Timestamp(6)
  customer_id        Int
  order_id           Int?
  document_number    String         @db.VarChar(20)
  receipt_number     String?        @db.VarChar(20)
  transaction_type   String         @db.VarChar(10)
  previous_balance   Decimal        @db.Decimal(10, 2)
  transaction_amount Decimal        @db.Decimal(10, 2)
  total              Decimal        @db.Decimal(10, 2)
  payment_method_id  Int            @default(1) @db.SmallInt
  notes              String?
  user_id            Int?
  is_active          Boolean        @default(true)
  updated_at         DateTime?      @updatedAt
  updated_by         Int?
  payment_line       payment_line[]
  order_header       order_header?  @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_order")
  payment_method     payment_method @relation(fields: [payment_method_id], references: [payment_method_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_paymenttrans_paymentmethod")
  user               User?          @relation("PaymentTransactionUser", fields: [user_id], references: [id])
  updated_by_user    User?          @relation("PaymentTransactionUpdatedBy", fields: [updated_by], references: [id])
}

model payment_audit {
  audit_id       Int       @id @default(autoincrement())
  table_name     String    @db.VarChar(50)
  record_id      Int
  operation_type String    @db.VarChar(20)
  old_values     Json?
  new_values     Json?
  created_at     DateTime  @default(now())
  created_by     Int?
  reason         String?
  ip_address     String?   @db.VarChar(45)
  user_agent     String?
  created_by_user User?    @relation("PaymentAuditCreatedBy", fields: [created_by], references: [id])
  
  @@index([table_name, record_id])
  @@index([created_at])
  @@index([created_by])
  @@index([operation_type])
}

model payment_line {
  payment_line_id     Int                 @id @default(autoincrement())
  transaction_id      Int
  product_id          Int?
  quantity            Int
  unit_price          Decimal             @db.Decimal(10, 2)
  subtotal            Decimal             @db.Decimal(10, 2)
  notes               String?
  product             product?            @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_line_product")
  payment_transaction payment_transaction @relation(fields: [transaction_id], references: [transaction_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_line_transaction")
}

model payment_installment {
  installment_id         Int                      @id @default(autoincrement())
  customer_id            Int
  due_date               DateTime                 @db.Timestamp(6)
  delivered_quantity     Int
  amount_paid            Decimal                  @db.Decimal(10, 2)
  total_amount           Decimal                  @db.Decimal(10, 2)
  installment_order_link installment_order_link[]
  customer               person                   @relation("PaymentInstallmentToPerson", fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
}

model installment_order_link {
  link_id                 Int                 @id @default(autoincrement())
  installment_id          Int
  order_id                Int
  order_itemOrder_item_id Int?
  payment_installment     payment_installment @relation(fields: [installment_id], references: [installment_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_installment_order_installment")
  order_header            order_header        @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_installment_order_order")
  order_item              order_item?         @relation(fields: [order_itemOrder_item_id], references: [order_item_id])
}

model vehicle {
  vehicle_id        Int                 @id @default(autoincrement()) @db.SmallInt
  code              String              @unique @db.VarChar(20)
  name              String              @db.VarChar(50)
  description       String?
  is_active         Boolean             @default(true)
  delivery_stats    delivery_stats[]
  route_sheet       route_sheet[]
  user_vehicle      user_vehicle[]
  vehicle_inventory vehicle_inventory[]
  vehicle_zone      vehicle_zone[]
}

model vehicle_inventory {
  vehicle_id      Int     @db.SmallInt
  product_id      Int
  quantity_loaded Int
  quantity_empty  Int?
  product         product @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_vehicleinventory_product")
  vehicle         vehicle @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_vehicleinventory_vehicle")

  @@id([vehicle_id, product_id])
}

model vehicle_zone {
  vehicle_zone_id Int      @id @default(autoincrement())
  vehicle_id      Int      @db.SmallInt
  zone_id         Int      @db.SmallInt
  assigned_at     DateTime @default(now())
  is_active       Boolean  @default(true)
  notes           String?
  vehicle         vehicle  @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_vehicle_zone_vehicle")
  zone            zone     @relation(fields: [zone_id], references: [zone_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_vehicle_zone_zone")

  @@unique([vehicle_id, zone_id], name: "unique_vehicle_zone")
  @@index([vehicle_id])
  @@index([zone_id])
  @@index([is_active])
}

model user_vehicle {
  user_vehicle_id Int      @id @default(autoincrement())
  user_id         Int
  vehicle_id      Int      @db.SmallInt
  assigned_at     DateTime @default(now())
  is_active       Boolean  @default(true)
  notes           String?
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_vehicle_user")
  vehicle         vehicle  @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_vehicle_vehicle")

  @@unique([user_id, vehicle_id], name: "unique_user_vehicle")
  @@index([user_id])
  @@index([vehicle_id])
  @@index([is_active])
}

model route_sheet {
  route_sheet_id                       Int                       @id @default(autoincrement())
  driver_id                            Int
  vehicle_id                           Int                       @db.SmallInt
  delivery_date                        DateTime                  @db.Date
  route_notes                          String?
  driver_reconciliation_signature_path String?
  reconciliation_at                    DateTime?
  is_active                            Boolean                   @default(true)
  delivery_stats                       delivery_stats[]
  inventory_transaction                inventory_transaction[]
  route_optimization                   route_optimization[]
  driver                               User                      @relation(fields: [driver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_driver")
  vehicle                              vehicle                   @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_vehicle")
  route_sheet_detail                   route_sheet_detail[]
  vehicle_route_inventory              vehicle_route_inventory[]
  cancellation_order cancellation_order[]
}

model route_sheet_detail {
  route_sheet_detail_id      Int                      @id @default(autoincrement())
  route_sheet_id             Int
  order_id                   Int?                    
  one_off_purchase_id        Int?                     
  one_off_purchase_header_id Int?                     
  cancellation_order_id      Int?
  cycle_payment_id           Int?
  delivery_status            String                   @db.VarChar(20)
  delivery_time              String?                  @db.VarChar(50)
  comments                   String?
  digital_signature_id       String?                  @db.VarChar(100)
  actual_arrival_time        DateTime?
  delivery_notes             String?
  estimated_arrival_time     DateTime?
  lat                        Decimal?                 @db.Decimal(10, 8)
  lng                        Decimal?                 @db.Decimal(10, 8)
  recipient_name             String?
  rejection_reason           String?
  reschedule_date            DateTime?
  sequence_number            Int?
  delivery_evidence          delivery_evidence[]
  delivery_incident          delivery_incident[]
  inventory_transaction      inventory_transaction[]
  order_header               order_header?            @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_detail_order")
  one_off_purchase           one_off_purchase?        @relation(fields: [one_off_purchase_id], references: [purchase_id], onDelete: NoAction, onUpdate: NoAction)
  one_off_purchase_header    one_off_purchase_header? @relation(fields: [one_off_purchase_header_id], references: [purchase_header_id], onDelete: NoAction, onUpdate: NoAction)
  cancellation_order         cancellation_order?      @relation(fields: [cancellation_order_id], references: [cancellation_order_id], onDelete: NoAction, onUpdate: NoAction)
  cycle_payment              cycle_payment?           @relation(fields: [cycle_payment_id], references: [payment_id], onDelete: NoAction, onUpdate: NoAction)
  route_sheet                route_sheet              @relation(fields: [route_sheet_id], references: [route_sheet_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_detail_route")
}

model route_optimization {
  optimization_id     Int         @id @default(autoincrement())
  route_sheet_id      Int
  created_at          DateTime    @default(now())
  estimated_duration  Int
  estimated_distance  Decimal     @db.Decimal(10, 2)
  optimization_status String
  waypoints           Json?
  route_sheet         route_sheet @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model vehicle_route_inventory {
  inventory_id      Int         @id @default(autoincrement())
  route_sheet_id    Int
  product_id        Int
  initial_quantity  Int
  current_quantity  Int
  returned_quantity Int
  product           product     @relation(fields: [product_id], references: [product_id])
  route_sheet       route_sheet @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model inventory_transaction {
  transaction_id   Int                 @id @default(autoincrement())
  route_sheet_id   Int
  detail_id        Int?
  product_id       Int
  quantity         Int
  transaction_type String
  created_at       DateTime            @default(now())
  detail           route_sheet_detail? @relation(fields: [detail_id], references: [route_sheet_detail_id])
  product          product             @relation(fields: [product_id], references: [product_id])
  route_sheet      route_sheet         @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model delivery_evidence {
  evidence_id           Int                @id @default(autoincrement())
  route_sheet_detail_id Int
  evidence_type         String
  file_path             String
  created_at            DateTime           @default(now())
  created_by            Int
  route_sheet_detail    route_sheet_detail @relation(fields: [route_sheet_detail_id], references: [route_sheet_detail_id])
}

model delivery_incident {
  incident_id           Int                @id @default(autoincrement())
  route_sheet_detail_id Int
  incident_type         String
  description           String
  created_at            DateTime           @default(now())
  created_by            Int
  status                String
  resolution            String?
  resolved_at           DateTime?
  resolved_by           Int?
  creator               User               @relation("incidentCreator", fields: [created_by], references: [id])
  resolver              User?              @relation("incidentResolver", fields: [resolved_by], references: [id])
  route_sheet_detail    route_sheet_detail @relation(fields: [route_sheet_detail_id], references: [route_sheet_detail_id])
}

model delivery_stats {
  stat_id                Int          @id @default(autoincrement())
  date                   DateTime     @db.Date
  driver_id              Int?
  vehicle_id             Int?
  zone_id                Int?         @db.SmallInt
  route_sheet_id         Int?
  total_deliveries       Int
  completed_deliveries   Int
  rejected_deliveries    Int
  rescheduled_deliveries Int
  avg_delivery_time      Int?
  avg_delay_time         Int?
  driver                 User?        @relation(fields: [driver_id], references: [id])
  route_sheet            route_sheet? @relation(fields: [route_sheet_id], references: [route_sheet_id])
  vehicle                vehicle?     @relation(fields: [vehicle_id], references: [vehicle_id])
  zone                   zone?        @relation(fields: [zone_id], references: [zone_id])
}

enum Role {
  DRIVERS
  ADMINISTRATIVE
  SUPERADMIN
  BOSSADMINISTRATIVE
}

enum OrderType {
  SUBSCRIPTION
  ONE_OFF
  CONTRACT_DELIVERY
  HYBRID
  COLLECTION
}

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PREPARATION
  READY_FOR_DELIVERY
  IN_DELIVERY
  DELIVERED
  RETIRADO
  CANCELLED
  REFUNDED
  OVERDUE
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum PersonType {
  INDIVIDUAL
  PLAN
  PROSPECT
}

enum ContractStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING_ACTIVATION
  ON_HOLD
}

enum ComodatoStatus {
  ACTIVE
  INACTIVE
  RETURNED
  DAMAGED
  LOST
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CREDITED
}

enum PaymentMode {
  ADVANCE     // Pago adelantado (inicio de mes)
  ARREARS     // Pago vencido (fin de mes o fechas espec√≠ficas)
}

model cycle_payment {
  payment_id      Int                 @id @default(autoincrement())
  cycle_id        Int
  payment_date    DateTime            @default(now())
  amount          Decimal             @db.Decimal(10, 2)
  payment_method  String              @db.VarChar(50)
  reference       String?             @db.VarChar(100)
  notes           String?
  created_by      Int?
  updated_at      DateTime?           @updatedAt
  updated_by      Int?
  subscription_cycle subscription_cycle @relation(fields: [cycle_id], references: [cycle_id], onDelete: Cascade, onUpdate: NoAction)
  route_sheet_detail route_sheet_detail[]
  created_by_user User?               @relation("CyclePaymentCreatedBy", fields: [created_by], references: [id])
  updated_by_user User?               @relation("CyclePaymentUpdatedBy", fields: [updated_by], references: [id])
  
  @@index([cycle_id])
  @@index([payment_date])
}

model cancellation_order {
  cancellation_order_id    Int                   @id @default(autoincrement())
  subscription_id          Int
  scheduled_collection_date DateTime             @db.Date
  actual_collection_date   DateTime?            @db.Date
  status                   CancellationOrderStatus @default(PENDING)
  route_sheet_id           Int?
  notes                    String?              @db.Text
  created_at               DateTime             @default(now())
  updated_at               DateTime             @updatedAt
  rescheduled_count        Int                  @default(0)
  customer_subscription    customer_subscription @relation(fields: [subscription_id], references: [subscription_id], onDelete: Cascade, onUpdate: NoAction)
  route_sheet              route_sheet?         @relation(fields: [route_sheet_id], references: [route_sheet_id], onDelete: SetNull, onUpdate: NoAction)
  route_sheet_detail       route_sheet_detail[]
  
  @@index([subscription_id])
  @@index([scheduled_collection_date])
  @@index([status])
}

enum CancellationOrderStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  RESCHEDULED
  CANCELLED
}

enum RecoveryStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  RESCHEDULED
  CANCELLED
}

model comodato {
  comodato_id          Int            @id @default(autoincrement())
  person_id            Int
  product_id           Int
  subscription_id      Int?
  quantity             Int
  max_quantity         Int?           // Cantidad m√°xima permitida seg√∫n la suscripci√≥n
  delivery_date        DateTime       @db.Date
  return_date          DateTime?      @db.Date
  expected_return_date DateTime?      @db.Date
  status               ComodatoStatus @default(ACTIVE)
  notes                String?        @db.Text
  deposit_amount       Decimal?       @db.Decimal(10, 2)
  monthly_fee          Decimal?       @db.Decimal(10, 2)
  article_description  String?        @db.VarChar(255)
  brand                String?        @db.VarChar(100)
  model                String?        @db.VarChar(100)
  contract_image_path  String?        @db.VarChar(500)
  created_at           DateTime       @default(now())
  updated_at           DateTime       @updatedAt
  is_active            Boolean        @default(true)
  person               person         @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  product              product        @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  subscription         customer_subscription? @relation(fields: [subscription_id], references: [subscription_id], onDelete: SetNull, onUpdate: NoAction)
  recovery_order       recovery_order?
  comodato_changes     comodato_change[]
  
  @@index([person_id])
  @@index([subscription_id])
  @@index([status])
  @@index([delivery_date])
  @@index([is_active])
}

model recovery_order {
  recovery_order_id        Int                   @id @default(autoincrement())
  comodato_id              Int                   @unique
  scheduled_recovery_date  DateTime             @db.Date
  actual_recovery_date     DateTime?            @db.Date
  status                   RecoveryStatus       @default(PENDING)
  notes                    String?              @db.Text
  created_at               DateTime             @default(now())
  updated_at               DateTime             @updatedAt
  comodato                 comodato             @relation(fields: [comodato_id], references: [comodato_id], onDelete: Cascade, onUpdate: NoAction)
  
  @@index([comodato_id])
  @@index([scheduled_recovery_date])
  @@index([status])
}

model comodato_change {
  change_id     Int      @id @default(autoincrement())
  comodato_id   Int
  change_date   DateTime @default(now())
  change_reason String   @db.Text
  old_status    ComodatoStatus?
  new_status    ComodatoStatus?
  changed_by    Int?
  notes         String?  @db.Text
  comodato      comodato @relation(fields: [comodato_id], references: [comodato_id], onDelete: Cascade, onUpdate: NoAction)
  user          User?    @relation(fields: [changed_by], references: [id], onDelete: SetNull, onUpdate: NoAction)
  
  @@index([comodato_id])
  @@index([change_date])
}
