// =============================================================================
// CONFIGURACIÓN DE PRISMA
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Role {
  USER
  ADMIN
}

enum OrderType {
  SUBSCRIPTION
  ONE_OFF
  CONTRACT_DELIVERY
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  PAID
  PARTIALLY_PAID
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

enum PersonType {
  INDIVIDUAL
  PLAN
  PROSPECT
}

enum ContractStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING_ACTIVATION
  ON_HOLD
}

// =============================================================================
// AUTENTICACIÓN Y USUARIOS
// =============================================================================

model User {
  id                   Int                   @id @default(autoincrement())
  email                String                @unique
  password             String
  name                 String
  role                 Role                  @default(ADMIN)
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime?
  recoveryToken        String?               @unique
  recoveryTokenExpires DateTime?
  profileImageUrl      String?
  refresh_tokens       RefreshToken[]
  incidents_created    delivery_incident[]   @relation("incidentCreator")
  incidents_resolved   delivery_incident[]   @relation("incidentResolver")
  delivery_stats       delivery_stats[]
  payment_transactions payment_transaction[]
  route_sheet          route_sheet[]
  user_vehicle         user_vehicle[]
  stock_movements      stock_movement[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// =============================================================================
// GEOGRAFÍA Y UBICACIONES
// =============================================================================

model country {
  country_id Int        @id @db.SmallInt
  code       String     @unique @db.VarChar(10)
  name       String     @db.VarChar(100)
  province   province[]
}

model province {
  province_id Int        @id @db.SmallInt
  country_id  Int        @db.SmallInt
  code        String     @unique @db.VarChar(10)
  name        String     @db.VarChar(100)
  locality    locality[]
  country     country    @relation(fields: [country_id], references: [country_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_province_country")
}

model locality {
  locality_id      Int                @id @db.SmallInt
  province_id      Int                @db.SmallInt
  code             String             @db.VarChar(10)
  name             String             @db.VarChar(100)
  province         province           @relation(fields: [province_id], references: [province_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_locality_province")
  zones            zone[]
  one_off_purchase one_off_purchase[]
  person           person[]
  warehouse        warehouse[]
}

model zone {
  zone_id          Int                @id @default(autoincrement()) @db.SmallInt
  locality_id      Int                @db.SmallInt
  code             String             @db.VarChar(10)
  name             String             @db.VarChar(100)
  locality         locality           @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_zone_locality")
  delivery_stats   delivery_stats[]
  one_off_purchase one_off_purchase[]
  person           person[]
  vehicle_zone     vehicle_zone[]

  @@unique([locality_id, code], name: "unique_zone_code_per_locality")
  @@unique([locality_id, name], name: "unique_zone_name_per_locality")
}

// =============================================================================
// PRODUCTOS Y CATEGORÍAS
// =============================================================================

model product_category {
  category_id Int       @id @default(autoincrement()) @db.SmallInt
  name        String    @db.VarChar(50)
  product     product[]
}

model product {
  product_id                Int                         @id @default(autoincrement())
  category_id               Int                         @db.SmallInt
  description               String                      @db.VarChar(100)
  volume_liters             Decimal?                    @db.Decimal(5, 2)
  price                     Decimal                     @db.Decimal(10, 2)
  is_returnable             Boolean
  serial_number             String?                     @db.VarChar(50)
  notes                     String?
  image_url                 String?                     @db.VarChar(255)
  inventory                 inventory[]
  inventory_transaction     inventory_transaction[]
  one_off_purchase          one_off_purchase[]
  order_item                order_item[]
  payment_line              payment_line[]
  price_list_item           price_list_item[]
  product_category          product_category            @relation(fields: [category_id], references: [category_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_product_category")
  stock_movement            stock_movement[]
  subscription_cycle_detail subscription_cycle_detail[]
  subscription_plan_product subscription_plan_product[]
  vehicle_inventory         vehicle_inventory[]
  vehicle_route_inventory   vehicle_route_inventory[]
}

// =============================================================================
// PRECIOS Y LISTAS DE PRECIOS
// =============================================================================

model price_list {
  price_list_id   Int               @id @default(autoincrement())
  name            String            @db.VarChar(50)
  description     String?           @db.VarChar(255)
  effective_date  DateTime          @db.Date
  is_default      Boolean           @default(false)
  active          Boolean           @default(true)
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  client_contract client_contract[]
  price_list_item price_list_item[]
}

model price_list_item {
  price_list_item_id Int                  @id @default(autoincrement())
  price_list_id      Int
  product_id         Int
  unit_price         Decimal              @db.Decimal(10, 2)
  price_history      price_list_history[]
  price_list         price_list           @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pricelistitem_pricelist")
  product            product              @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pricelistitem_product")
}

model price_list_history {
  history_id         Int             @id @default(autoincrement())
  price_list_item_id Int
  previous_price     Decimal         @db.Decimal(10, 2)
  new_price          Decimal         @db.Decimal(10, 2)
  change_date        DateTime        @default(now()) @db.Timestamp(6)
  change_percentage  Decimal?        @db.Decimal(10, 2)
  change_reason      String?
  created_by         String?         @db.VarChar(100)
  price_list_item    price_list_item @relation(fields: [price_list_item_id], references: [price_list_item_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([price_list_item_id])
  @@index([change_date])
}

// =============================================================================
// ALMACENES E INVENTARIO
// =============================================================================

model warehouse {
  warehouse_id                                                      Int              @id @default(autoincrement())
  name                                                              String           @db.VarChar(100)
  locality_id                                                       Int?             @db.SmallInt
  inventory                                                         inventory[]
  stock_movement_stock_movement_destination_warehouse_idTowarehouse stock_movement[] @relation("stock_movement_destination_warehouse_idTowarehouse")
  stock_movement_stock_movement_source_warehouse_idTowarehouse      stock_movement[] @relation("stock_movement_source_warehouse_idTowarehouse")
  locality                                                          locality?        @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_warehouse_locality")
}

model inventory {
  warehouse_id Int       @db.SmallInt
  product_id   Int
  quantity     Int
  product      product   @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_inventory_product")
  warehouse    warehouse @relation(fields: [warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_inventory_warehouse")

  @@id([warehouse_id, product_id])
}

model movement_type {
  movement_type_id Int              @id @default(autoincrement())
  code             String           @unique @db.VarChar(100)
  description      String           @db.VarChar(100)
  stock_movement   stock_movement[]
}

model stock_movement {
  stock_movement_id        Int      @id @default(autoincrement())
  movement_date            DateTime @db.Timestamp(6)
  movement_type_id         Int      @db.SmallInt
  product_id               Int
  source_warehouse_id      Int?     @db.SmallInt
  destination_warehouse_id Int?     @db.SmallInt
  quantity                 Int
  remarks                  String?
  order_id                 Int? // Referencia a la orden/venta
  user_id                  Int? // Usuario que registró el movimiento
  reference_document       String?  @db.VarChar(50) // Número de factura, recibo, etc.

  warehouse_stock_movement_destination_warehouse_idTowarehouse warehouse?    @relation("stock_movement_destination_warehouse_idTowarehouse", fields: [destination_warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_dest_warehouse")
  movement_type                                                movement_type @relation(fields: [movement_type_id], references: [movement_type_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_movement_type")
  product                                                      product       @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_product")
  warehouse_stock_movement_source_warehouse_idTowarehouse      warehouse?    @relation("stock_movement_source_warehouse_idTowarehouse", fields: [source_warehouse_id], references: [warehouse_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_stockmovement_source_warehouse")
  order_header                                                 order_header? @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction)
  user                                                         User?         @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

// =============================================================================
// CLIENTES Y PERSONAS
// =============================================================================

model person {
  person_id             Int                     @id @default(autoincrement())
  phone                 String                  @unique @db.VarChar(20)
  name                  String?                 @db.VarChar(100)
  alias                 String?                 @db.VarChar(100)
  tax_id                String?                 @db.VarChar(20)
  address               String?                 @db.VarChar(200)
  locality_id           Int?                    @db.SmallInt
  zone_id               Int?                    @db.SmallInt
  registration_date     DateTime                @default(dbgenerated("CURRENT_DATE")) @db.Date
  type                  PersonType
  client_contract       client_contract[]
  customer_subscription customer_subscription[]
  one_off_purchase      one_off_purchase[]
  orders                order_header[]          @relation("OrderHeaderToPerson")
  paymentInstallments   payment_installment[]   @relation("PaymentInstallmentToPerson")
  locality              locality?               @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction)
  zone                  zone?                   @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([name])
  @@index([alias])
  @@index([tax_id])
}

model client_contract {
  contract_id                Int                          @id @default(autoincrement())
  person_id                  Int
  price_list_id              Int
  start_date                 DateTime                     @db.Date
  end_date                   DateTime?                    @db.Date
  notes                      String?
  status                     ContractStatus               @default(ACTIVE)
  person                     person                       @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_contract_person")
  price_list                 price_list                   @relation(fields: [price_list_id], references: [price_list_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_contract_pricelist")
  contract_delivery_schedule contract_delivery_schedule[]
  order_header               order_header[]
}

model contract_delivery_schedule {
  schedule_id     Int             @id @default(autoincrement())
  contract_id     Int
  day_of_week     Int             @db.SmallInt
  scheduled_time  DateTime        @db.Time(6)
  client_contract client_contract @relation(fields: [contract_id], references: [contract_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_schedule_contract")
}

// =============================================================================
// SUSCRIPCIONES
// =============================================================================

model subscription_plan {
  subscription_plan_id         Int                         @id @default(autoincrement()) @db.SmallInt
  name                         String                      @db.VarChar(50)
  description                  String?
  price                        Decimal?                    @db.Decimal(10, 2)
  default_cycle_days           Int                         @default(30) // Valor por defecto para nuevas suscripciones
  default_deliveries_per_cycle Int                         @default(1) // Valor por defecto para nuevas suscripciones
  is_active                    Boolean                     @default(true) // Si el plan está disponible para nuevas suscripciones
  created_at                   DateTime                    @default(now())
  updated_at                   DateTime                    @updatedAt
  customer_subscription        customer_subscription[]
  subscription_plan_product    subscription_plan_product[]
}

model subscription_plan_product {
  spp_id               Int               @id @default(autoincrement())
  subscription_plan_id Int               @db.SmallInt
  product_id           Int
  product_quantity     Int
  subscription_plan    subscription_plan @relation(fields: [subscription_plan_id], references: [subscription_plan_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_spp_plan")
  product              product           @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_spp_product")
}

model customer_subscription {
  subscription_id                Int                              @id @default(autoincrement())
  customer_id                    Int
  subscription_plan_id           Int                              @db.SmallInt
  start_date                     DateTime                         @db.Date
  end_date                       DateTime?                        @db.Date
  status                         SubscriptionStatus
  notes                          String?
  subscription_plan              subscription_plan                @relation(fields: [subscription_plan_id], references: [subscription_plan_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cust_sub_plan")
  person                         person                           @relation(fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_customer_subscription_person")
  order_header                   order_header[]
  subscription_cycle             subscription_cycle[]
  subscription_delivery_schedule subscription_delivery_schedule[]

  @@index([status])
}

model subscription_cycle {
  cycle_id                  Int                         @id @default(autoincrement())
  subscription_id           Int
  cycle_start               DateTime                    @db.Date
  cycle_end                 DateTime                    @db.Date
  notes                     String?
  customer_subscription     customer_subscription       @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_subscription")
  subscription_cycle_detail subscription_cycle_detail[]
}

model subscription_cycle_detail {
  cycle_detail_id    Int                @id @default(autoincrement())
  cycle_id           Int
  product_id         Int
  planned_quantity   Int
  delivered_quantity Int                @default(0)
  remaining_balance  Int
  subscription_cycle subscription_cycle @relation(fields: [cycle_id], references: [cycle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_detail_cycle")
  product            product            @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cycle_detail_product")
}

model subscription_delivery_schedule {
  schedule_id           Int                   @id @default(autoincrement())
  subscription_id       Int
  day_of_week           Int                   @db.SmallInt
  scheduled_time        String                @db.VarChar(20)
  customer_subscription customer_subscription @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_sub_schedule_subscription")
}

// =============================================================================
// CANALES DE VENTA
// =============================================================================

model sale_channel {
  sale_channel_id  Int                @id @default(autoincrement())
  code             String             @unique @db.VarChar(20)
  description      String             @db.VarChar(100)
  one_off_purchase one_off_purchase[]
  order_header     order_header[]
}

// =============================================================================
// ÓRDENES Y VENTAS
// =============================================================================

model order_header {
  order_id                Int                      @id @default(autoincrement())
  customer_id             Int
  contract_id             Int?
  sale_channel_id         Int                      @default(1) @db.SmallInt
  order_date              DateTime                 @db.Timestamp(6)
  scheduled_delivery_date DateTime?                @db.Timestamp(6)
  delivery_time           DateTime?                @db.Time(6)
  total_amount            Decimal                  @db.Decimal(10, 2)
  paid_amount             Decimal                  @db.Decimal(10, 2)
  order_type              OrderType
  status                  OrderStatus
  notes                   String?
  subscription_id         Int?
  installment_order_link  installment_order_link[]
  client_contract         client_contract?         @relation(fields: [contract_id], references: [contract_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_contract")
  sale_channel            sale_channel             @relation(fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_salechannel")
  customer                person                   @relation("OrderHeaderToPerson", fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  customer_subscription   customer_subscription?   @relation(fields: [subscription_id], references: [subscription_id], onDelete: NoAction, onUpdate: NoAction)
  order_item              order_item[]
  payment_transaction     payment_transaction[]
  route_sheet_detail      route_sheet_detail[]
  stock_movements         stock_movement[]

  @@index([order_date])
  @@index([status])
}

model order_item {
  order_item_id          Int                      @id @default(autoincrement())
  order_id               Int
  product_id             Int
  quantity               Int
  subtotal               Decimal                  @db.Decimal(10, 2)
  delivered_quantity     Int?                     @default(0)
  returned_quantity      Int?                     @default(0)
  amount_paid            Decimal                  @db.Decimal(10, 2)
  total_amount           Decimal                  @db.Decimal(10, 2)
  installment_order_link installment_order_link[]
  order_header           order_header             @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orderitem_order")
  product                product                  @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_orderitem_product")
}

model one_off_purchase {
  purchase_id      Int          @id @default(autoincrement())
  person_id        Int
  product_id       Int
  quantity         Int
  total_amount     Decimal      @db.Decimal(10, 2)
  purchase_date    DateTime     @default(now()) @db.Timestamp(6)
  sale_channel_id  Int          @db.SmallInt
  delivery_address String?
  locality_id      Int?         @db.SmallInt
  zone_id          Int?         @db.SmallInt
  locality         locality?    @relation(fields: [locality_id], references: [locality_id], onDelete: NoAction, onUpdate: NoAction)
  person           person       @relation(fields: [person_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
  product          product      @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction)
  sale_channel     sale_channel @relation(fields: [sale_channel_id], references: [sale_channel_id], onDelete: NoAction, onUpdate: NoAction)
  zone             zone?        @relation(fields: [zone_id], references: [zone_id], onDelete: NoAction, onUpdate: NoAction)
}

// =============================================================================
// PAGOS Y TRANSACCIONES
// =============================================================================

model payment_method {
  payment_method_id   Int                   @id @default(autoincrement())
  code                String                @unique @db.VarChar(20)
  description         String                @db.VarChar(100)
  payment_transaction payment_transaction[]
}

model payment_transaction {
  transaction_id     Int            @id @default(autoincrement())
  transaction_date   DateTime       @db.Timestamp(6)
  customer_id        Int
  order_id           Int?
  document_number    String         @db.VarChar(20)
  receipt_number     String?        @db.VarChar(20)
  transaction_type   String         @db.VarChar(10)
  previous_balance   Decimal        @db.Decimal(10, 2)
  transaction_amount Decimal        @db.Decimal(10, 2)
  total              Decimal        @db.Decimal(10, 2)
  payment_method_id  Int            @default(1) @db.SmallInt
  notes              String?
  user_id            Int?
  payment_line       payment_line[]
  order_header       order_header?  @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_order")
  payment_method     payment_method @relation(fields: [payment_method_id], references: [payment_method_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_paymenttrans_paymentmethod")
  user               User?          @relation(fields: [user_id], references: [id])
}

model payment_line {
  payment_line_id     Int                 @id @default(autoincrement())
  transaction_id      Int
  product_id          Int?
  quantity            Int
  unit_price          Decimal             @db.Decimal(10, 2)
  subtotal            Decimal             @db.Decimal(10, 2)
  notes               String?
  product             product?            @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_line_product")
  payment_transaction payment_transaction @relation(fields: [transaction_id], references: [transaction_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_payment_line_transaction")
}

model payment_installment {
  installment_id         Int                      @id @default(autoincrement())
  customer_id            Int
  due_date               DateTime                 @db.Timestamp(6)
  delivered_quantity     Int
  amount_paid            Decimal                  @db.Decimal(10, 2)
  total_amount           Decimal                  @db.Decimal(10, 2)
  installment_order_link installment_order_link[]
  customer               person                   @relation("PaymentInstallmentToPerson", fields: [customer_id], references: [person_id], onDelete: NoAction, onUpdate: NoAction)
}

model installment_order_link {
  link_id                 Int                 @id @default(autoincrement())
  installment_id          Int
  order_id                Int
  order_itemOrder_item_id Int?
  payment_installment     payment_installment @relation(fields: [installment_id], references: [installment_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_installment_order_installment")
  order_header            order_header        @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_installment_order_order")
  order_item              order_item?         @relation(fields: [order_itemOrder_item_id], references: [order_item_id])
}

// =============================================================================
// VEHÍCULOS Y LOGÍSTICA
// =============================================================================

model vehicle {
  vehicle_id        Int                 @id @default(autoincrement()) @db.SmallInt
  code              String              @unique @db.VarChar(20)
  name              String              @db.VarChar(50)
  description       String?
  delivery_stats    delivery_stats[]
  route_sheet       route_sheet[]
  vehicle_inventory vehicle_inventory[]
  vehicle_zone      vehicle_zone[]
  user_vehicle      user_vehicle[]
}

model vehicle_inventory {
  vehicle_id      Int     @db.SmallInt
  product_id      Int
  quantity_loaded Int
  quantity_empty  Int?
  product         product @relation(fields: [product_id], references: [product_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_vehicleinventory_product")
  vehicle         vehicle @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_vehicleinventory_vehicle")

  @@id([vehicle_id, product_id])
}

model vehicle_zone {
  vehicle_zone_id Int      @id @default(autoincrement())
  vehicle_id      Int      @db.SmallInt
  zone_id         Int      @db.SmallInt
  assigned_at     DateTime @default(now())
  is_active       Boolean  @default(true)
  notes           String?
  vehicle         vehicle  @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_vehicle_zone_vehicle")
  zone            zone     @relation(fields: [zone_id], references: [zone_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_vehicle_zone_zone")

  @@unique([vehicle_id, zone_id], name: "unique_vehicle_zone")
  @@index([vehicle_id])
  @@index([zone_id])
  @@index([is_active])
}

model user_vehicle {
  user_vehicle_id Int      @id @default(autoincrement())
  user_id         Int
  vehicle_id      Int      @db.SmallInt
  assigned_at     DateTime @default(now())
  is_active       Boolean  @default(true)
  notes           String?
  user            User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_vehicle_user")
  vehicle         vehicle  @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_vehicle_vehicle")

  @@unique([user_id, vehicle_id], name: "unique_user_vehicle")
  @@index([user_id])
  @@index([vehicle_id])
  @@index([is_active])
}

// =============================================================================
// ENTREGAS Y RUTAS
// =============================================================================

model route_sheet {
  route_sheet_id                       Int                       @id @default(autoincrement())
  driver_id                            Int
  vehicle_id                           Int                       @db.SmallInt
  delivery_date                        DateTime                  @db.Date
  route_notes                          String?
  driver_reconciliation_signature_path String?
  reconciliation_at                    DateTime?
  delivery_stats                       delivery_stats[]
  inventory_transaction                inventory_transaction[]
  route_optimization                   route_optimization[]
  driver                               User                      @relation(fields: [driver_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_driver")
  vehicle                              vehicle                   @relation(fields: [vehicle_id], references: [vehicle_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_vehicle")
  route_sheet_detail                   route_sheet_detail[]
  vehicle_route_inventory              vehicle_route_inventory[]
}

model route_sheet_detail {
  route_sheet_detail_id  Int                     @id @default(autoincrement())
  route_sheet_id         Int
  order_id               Int
  delivery_status        String                  @db.VarChar(20)
  delivery_time          DateTime?               @db.Timestamp(6)
  comments               String?
  digital_signature_id   String?                 @db.VarChar(100)
  actual_arrival_time    DateTime?
  delivery_notes         String?
  estimated_arrival_time DateTime?
  lat                    Decimal?                @db.Decimal(10, 8)
  lng                    Decimal?                @db.Decimal(10, 8)
  recipient_name         String?
  rejection_reason       String?
  reschedule_date        DateTime?
  sequence_number        Int?
  delivery_evidence      delivery_evidence[]
  delivery_incident      delivery_incident[]
  inventory_transaction  inventory_transaction[]
  order_header           order_header            @relation(fields: [order_id], references: [order_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_detail_order")
  route_sheet            route_sheet             @relation(fields: [route_sheet_id], references: [route_sheet_id], onDelete: NoAction, onUpdate: NoAction, map: "fk_route_detail_route")
}

model route_optimization {
  optimization_id     Int         @id @default(autoincrement())
  route_sheet_id      Int
  created_at          DateTime    @default(now())
  estimated_duration  Int
  estimated_distance  Decimal     @db.Decimal(10, 2)
  optimization_status String
  waypoints           Json?
  route_sheet         route_sheet @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model vehicle_route_inventory {
  inventory_id      Int         @id @default(autoincrement())
  route_sheet_id    Int
  product_id        Int
  initial_quantity  Int
  current_quantity  Int
  returned_quantity Int
  product           product     @relation(fields: [product_id], references: [product_id])
  route_sheet       route_sheet @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model inventory_transaction {
  transaction_id   Int                 @id @default(autoincrement())
  route_sheet_id   Int
  detail_id        Int?
  product_id       Int
  quantity         Int
  transaction_type String
  created_at       DateTime            @default(now())
  detail           route_sheet_detail? @relation(fields: [detail_id], references: [route_sheet_detail_id])
  product          product             @relation(fields: [product_id], references: [product_id])
  route_sheet      route_sheet         @relation(fields: [route_sheet_id], references: [route_sheet_id])
}

model delivery_evidence {
  evidence_id           Int                @id @default(autoincrement())
  route_sheet_detail_id Int
  evidence_type         String
  file_path             String
  created_at            DateTime           @default(now())
  created_by            Int
  route_sheet_detail    route_sheet_detail @relation(fields: [route_sheet_detail_id], references: [route_sheet_detail_id])
}

model delivery_incident {
  incident_id           Int                @id @default(autoincrement())
  route_sheet_detail_id Int
  incident_type         String
  description           String
  created_at            DateTime           @default(now())
  created_by            Int
  status                String
  resolution            String?
  resolved_at           DateTime?
  resolved_by           Int?
  creator               User               @relation("incidentCreator", fields: [created_by], references: [id])
  resolver              User?              @relation("incidentResolver", fields: [resolved_by], references: [id])
  route_sheet_detail    route_sheet_detail @relation(fields: [route_sheet_detail_id], references: [route_sheet_detail_id])
}

// =============================================================================
// ESTADÍSTICAS Y REPORTES
// =============================================================================

model delivery_stats {
  stat_id                Int          @id @default(autoincrement())
  date                   DateTime     @db.Date
  driver_id              Int?
  vehicle_id             Int?
  zone_id                Int?         @db.SmallInt
  route_sheet_id         Int?
  total_deliveries       Int
  completed_deliveries   Int
  rejected_deliveries    Int
  rescheduled_deliveries Int
  avg_delivery_time      Int?
  avg_delay_time         Int?
  driver                 User?        @relation(fields: [driver_id], references: [id])
  route_sheet            route_sheet? @relation(fields: [route_sheet_id], references: [route_sheet_id])
  vehicle                vehicle?     @relation(fields: [vehicle_id], references: [vehicle_id])
  zone                   zone?        @relation(fields: [zone_id], references: [zone_id])
}
